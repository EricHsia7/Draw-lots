<head f="ga">
  <meta charset="UTF-8" />
  <title>抽籤</title>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NYWXHF11W2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "G-NYWXHF11W2");
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <link type="image/x-icon" href="pwaicon/512x512.ico" rel="icon" />
  <link type="image/x-icon" href="pwaicon/512x512.ico" rel="bookmark" />
  <link type="image/x-icon" href="pwaicon/512x512.ico" rel="shortcut icon" />
  <link href="pwaicon/512x512.png" sizes="512x512" rel="apple-touch-icon-precomposed" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="defualt" />
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script>
    // VConsole will be exported to `window.VConsole` by default.
    var vConsole = new window.VConsole();
  </script>

  <style>
    :root {
      --r-000000: #000;
      --r-f4f4f4: #f4f4f4;
      --r-e3e3e3: #e3e3e3;
      --r-ffffff: #fff;
      --r-888888: #888;
    }

    * {
      outline: none;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    .list {
      list-style: none;
    }

    .list li {
      height: 45px;
      display: flex;
      justify-content: left;
      align-items: center;
      border-bottom: 1px var(--r-f4f4f4) solid;
      position: relative;
      color: rgba(170, 200, 193, 1);
      font-family: "Noto Sans TC", sans-serif;
      box-sizing: border-box;
    }

    .list li .delete_btn {
      position: absolute;
      width: 35px;
      height: 35px;
      top: 5px;
      right: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      -webkit-user-select: none;
    }

    .list li .delete_btn svg {
      width: 17px;
      height: 17px;
    }

    .list li input[type="text"] {
      position: absolute;
      top: 3px;
      left: 3px;
      padding: 0px;
      margin: 0px;
      -webkit-appearance: none;
      border: none;
      border-radius: 0px;
      background-color: transparent;
      height: 39px;
      width: calc(100% - 3px - 45px);
      font-size: 18px;
      caret-color: var(--r-000000);
      color: var(--r-000000)
    }

    .addli {
      width: 100%;
      height: 45px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: row;
      margin-bottom: 100px;
      color: var(--r-000000);
      font-family: "Noto Sans TC", sans-serif;
      font-weight: 700;
      -webkit-user-select: none;
      user-select: none;
      font-size: 22px;
    }

    .addli svg {
      width: 18px;
      height: 18px;
    }

    .sendbar * {
      -webkit-user-select: none;
      user-select: none;
    }

    .sendbar {
      position: fixed;
      left: 0px;
      bottom: 0px;
      width: 100%;
      height: 60px;
      background: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: row;
      border-top: 1px var(--r-f4f4f4) solid;
    }

    .sbtn {
      width: calc(100% - 5px);
      max-width: 350px;
      height: 45px;
      border-radius: 12px;
      background: var(--r-e3e3e3);
      color: var(--r-000000);
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: "Noto Sans TC", sans-serif;
      font-weight: 700;
    }

    #sharejson,
    #geturl {
      width: calc(100% - 5px);
      max-width: 350px;
    }

    .ddr,
    .rrd,
    .fgt {
      position: fixed;
      top: 0px;
      left: 0px;
      width: calc(100% - 10px);
      padding: 5px;
      height: 100%;
      background: var(--r-ffffff);
      overflow-y: scroll;
      overflow-x: hidden;
      transition: 0.3s;
    }

    .rrd,
    .ddr {
      display: none;
      opacity: 0;
    }

    .fgt img {
      width: 130px;
      height: 130px;
      -webkit-user-select: none;
      user-select: none;
    }

    .fgt .fgtce {
      -webkit-user-select: none;
      user-select: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .fgt p {
      color: var(--r-888888);
      -webkit-user-select: none;
      user-select: none;
      font-family: "Noto Sans TC", sans-serif;
    }

    #result {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: "Noto Sans TC", sans-serif;
      font-weight: 700;
      color: var(--r-000000);
      -webkit-user-select: none;
      user-select: none;
    }

    h3 {
      margin: 0px;
      padding: 0px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--r-888888);
      -webkit-user-select: none;
      user-select: none;
    }

    .fg {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      -webkit-user-select: none;
      user-select: none;
    }

    #start,
    #addfri {
      transition: 0.3s;
    }

    #start[yu="0"],
    #start[yu="3"],
    #addfri[yu="3"] {
      opacity: 1;
    }

    #start[yu="1"],
    #addfri[yu="1"] {
      opacity: 0.5;
    }
  </style>
</head>

<div class="fgt">
  <div class="fgtce">
    <img src="https://erichsia7.github.io/Draw-lots/F5499CB6-6352-47E7-9BFF-4373C15D2CDE.png" />
    <p>按下開始建立即可建立抽籤</p>
  </div>
  <div class="sendbar">
    <div class="sbtn fg" id="start" yu="1">開始建立</div>
  </div>
</div>

<div class="ddr">
  <h3>建立抽籤</h3>
  <div class="list">
  </div>
  <div class="addli">
    <svg stroke-miterlimit="10" style="fill-rule:nonzero;clip-rule:evenodd;stroke-linecap:round;stroke-linejoin:round;"
      version="1.1" viewBox="0 0 64 64" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink">
      <path
        d="M28.5714 64L28.5714 35.4286L1.42109e-14 35.4286L1.42109e-14 28.5714L28.5714 28.5714L28.5714 7.10543e-15L35.4286 7.10543e-15L35.4286 28.5714L64 28.5714L64 35.4286L35.4286 35.4286L35.4286 64L28.5714 64Z"
        fill="var(--r-000000)" fill-rule="evenodd" opacity="1" stroke="none" />
    </svg>
    新增項目
  </div>
  <div class="sendbar">
    <div class="sbtn next_1">開始抽籤</div>
  </div>
</div>

<div class="rrd">
  <h3>抽籤結果</h3>
  <h2 id="result">結果</h2>
  <div class="sendbar">
    <div class="sbtn next_2">傳送結果</div>
  </div>
</div>

<script>
  var getUrlString = location.href;
  var url = new URL(getUrlString);
  var liffu = url.searchParams.get("liff");
  var result = ''
  if (liffu === "true") {
    $("h3").css({ 'display': 'none' })
  }
  let delete_icon = '<svg stroke-miterlimit="10" style="fill-rule:nonzero;clip-rule:evenodd;stroke-linecap:round;stroke-linejoin:round;" version="1.1" viewBox="0 0 64 64" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M4.92308 64L0 59.0769L27.0769 32L1.11786e-06 4.92308L4.92308-5.5893e-07L32 27.0769L59.0769-1.67679e-06L64 4.92307L36.9231 32L64 59.0769L59.0769 64L32 36.9231L4.92308 64Z" fill="var(--r-000000)" fill-rule="evenodd" opacity="1" stroke="none"/></svg>'
  function genid(mode) {
    if (mode === "random") {
      var genidchars = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
      var genid = "";
      for (var i = 0; i < 8; i++) {
        var genrandomNumber = Math.floor(Math.random() * genidchars.length);
        genid += genidchars.substring(genrandomNumber, genrandomNumber + 1);
      }
      return genid;
    }
    if (mode === "random2") {
      var genidchars = "0123456789abcdefghijklmnopqrstuvwxyz"
      var genid = "";
      for (var i = 0; i < 32; i++) {
        var genrandomNumber = Math.floor(Math.random() * genidchars.length);
        genid += genidchars.substring(genrandomNumber, genrandomNumber + 1);
      }
      return genid;
    }
    if (mode === "uuid") {
      var genidchars4 = "abcdef012345678";
      var geniduu = [8, 4, 4, 4, 12];
      var genid4 = "";
      var genid5 = "";
      for (var ia = 0; ia < geniduu.length; ia++) {
        var genid4 = "";
        for (var i = 0; i < geniduu[ia]; i++) {
          var genrandomNumber4 = Math.floor(Math.random() * genidchars4.length);
          genid4 += genidchars4.substring(genrandomNumber4, genrandomNumber4 + 1);
        }
        genid5 += "-" + genid4;
      }
      return genid5.substring(1, genid5.length);
    }
  }
  liff
    .init({
      liffId: "1656214165-JPk2V1O2", // Use own liffId
    })
    .then(() => {
      // Start to use liff's api
      //login
      if (!liff.isLoggedIn()) {
        liff.login({ redirectUri: "https://erichsia7.github.io/Draw-lots/" });
      }
      const accessToken = liff.getAccessToken();

      //checkfriend
      liff.getFriendship().then((data) => {
        if (data.friendFlag) {
          $("#start").attr("yu", "0");
        } else {
          $(".fgtce p").html("您必須先加入好友，才能使用這項功能。");
          $("#start").html("加入好友").attr("yu", "3").attr("id", "addfri");
          $("#addfri").click(function () {
            location.href = "https://line.me/R/ti/p/%40177dsovt";
          });
        }
      });
      liff
        .getProfile()
        .then((profile) => {
          const name = profile.displayName;
          var loid = genid("random");
          gtag("event", "logged_in", {
            event_category: "logged_in",
            event_label: profile.userId,
            transport_type: "beacon",
            event_callback: function () { },
          });
          liff.getFriendship().then((data) => {
            if (data.friendFlag) {
              gtag("event", "friendFlag", {
                event_category: "true",
                event_label: profile.userId,
                transport_type: "beacon",
                event_callback: function () { },
              });
            } else {
              gtag("event", "friendFlag", {
                event_category: "false",
                event_label: profile.userId,
                transport_type: "beacon",
                event_callback: function () { },
              });
            }
          });
          gtag("event", "User_OS", {
            event_category: liff.getOS(),
            event_label: profile.userId,
            transport_type: "beacon",
            event_callback: function () { },
          });
          gtag("event", "User_Lang", {
            event_category: liff.getLanguage(),
            event_label: profile.userId,
            transport_type: "beacon",
            event_callback: function () { },
          });
          gtag("event", "User_LINE_Ver", {
            event_category: liff.getLineVersion(),
            event_label: profile.userId,
            transport_type: "beacon",
            event_callback: function () { },
          });
          var dratime = "";
          var Today = new Date();
          $("#start").click(function () {
            if ($("#start").attr("yu") === "0") {
              Today = new Date();
              dratime = Today.getFullYear() + "." + (Today.getMonth() + 1) + "." + Today.getDate() + " " + Today.getHours() + ":" + Today.getMinutes();
              $("title").html("建立抽籤");
              $(".ddr").css({ 'display': 'block', 'opacity': '1' })
              gtag("event", "create", {
                event_category: "create",
                event_label: profile.userId,
                transport_type: "beacon",
                event_callback: function () { },
              });
              liff
                .sendMessages([
                  {
                    type: "flex",
                    altText: name + "已開始建立抽籤",
                    contents: {
                      type: "bubble",
                      body: {
                        type: "box",
                        layout: "vertical",
                        contents: [
                          {
                            type: "text",
                            text: "抽籤",
                            weight: "bold",
                            size: "xl",
                          },
                          {
                            type: "box",
                            layout: "vertical",
                            margin: "lg",
                            spacing: "sm",
                            contents: [
                              {
                                type: "box",
                                layout: "baseline",
                                spacing: "sm",
                                contents: [
                                  {
                                    type: "text",
                                    text: "建立者",
                                    color: "#aaaaaa",
                                    size: "sm",
                                    flex: 2,
                                  },
                                  {
                                    type: "text",
                                    text: name,
                                    wrap: true,
                                    color: "#666666",
                                    size: "sm",
                                    flex: 5,
                                  },
                                ],
                              },
                              {
                                type: "box",
                                layout: "baseline",
                                spacing: "sm",
                                contents: [
                                  {
                                    type: "text",
                                    text: "狀態",
                                    color: "#aaaaaa",
                                    size: "sm",
                                    flex: 2,
                                  },
                                  {
                                    type: "text",
                                    text: "建立中",
                                    wrap: true,
                                    color: "#666666",
                                    size: "sm",
                                    flex: 5,
                                  },
                                ],
                              },
                              {
                                type: "box",
                                layout: "baseline",
                                spacing: "sm",
                                contents: [
                                  {
                                    type: "text",
                                    color: "#aaaaaa",
                                    size: "sm",
                                    flex: 2,
                                    text: "建立時間",
                                  },
                                  {
                                    type: "text",
                                    text: dratime,
                                    wrap: true,
                                    color: "#666666",
                                    size: "sm",
                                    flex: 5,
                                  },
                                ],
                              },
                              {
                                type: "box",
                                layout: "baseline",
                                spacing: "sm",
                                contents: [
                                  {
                                    type: "text",
                                    text: "ID",
                                    color: "#aaaaaa",
                                    size: "sm",
                                    flex: 2,
                                  },
                                  {
                                    type: "text",
                                    text: loid,
                                    wrap: true,
                                    color: "#666666",
                                    size: "sm",
                                    flex: 5,
                                  },
                                ],
                              },
                            ],
                          },
                        ],
                      },
                    },
                  },
                ])
                .then(() => {
                })
                .catch((err) => {
                });
            }
          });
          $(".addli").click(function () {
            var list_id = 'l-' + genid('random2')
            $(".list").append('<li id="' + list_id + '"><input type="text" placeholder="輸入文字"><div class="delete_btn">' + delete_icon + '</div></li>');
            $('.list li#' + list_id + ' .delete_btn').click(function (e) {
              $('.list li#' + list_id).remove();
            });
          });
          var d_list = [];
          var d_list_json = [];
          $(".next_1").click(function () {
            gtag("event", "Drawing_lots", {
              event_category: $(".list li").length,
              event_label: profile.userId,
              transport_type: "beacon",
              event_callback: function () { },
            });
            $("title").html("抽籤結果");
            for (var i = 0; i < $(".list li").length; i++) {
              d_list.push(String($('.list li input[type="text"]').eq(i).val()))
              d_list_json.push({
                type: 'text',
                text: String($('.list li input[type="text"]').eq(i).val()),
                color: '#666666',
                size: 'sm'
              })
            }
            $(".rrd").css({ 'display': 'block', 'opacity': '1' })
            result = String(d_list[Math.floor(Math.random() * d_list.length)])
            $("#result").text(result)
            liff.sendMessages([
              {
                type: "flex",
                altText: name + "已開始抽籤",
                contents: {
                  type: "bubble",
                  body: {
                    type: "box",
                    layout: "vertical",
                    contents: [
                      {
                        type: "text",
                        text: "抽籤",
                        weight: "bold",
                        size: "xl",
                      },
                      {
                        type: "box",
                        layout: "vertical",
                        margin: "lg",
                        spacing: "sm",
                        contents: [
                          {
                            type: "box",
                            layout: "baseline",
                            spacing: "sm",
                            contents: [
                              {
                                type: "text",
                                text: "建立者",
                                color: "#aaaaaa",
                                size: "sm",
                                flex: 2,
                              },
                              {
                                type: "text",
                                text: name,
                                wrap: true,
                                color: "#666666",
                                size: "sm",
                                flex: 5,
                              },
                            ],
                          },
                          {
                            type: "box",
                            layout: "baseline",
                            spacing: "sm",
                            contents: [
                              {
                                type: "text",
                                text: "狀態",
                                color: "#aaaaaa",
                                size: "sm",
                                flex: 2,
                              },
                              {
                                type: "text",
                                text: "抽籤中",
                                wrap: true,
                                color: "#666666",
                                size: "sm",
                                flex: 5,
                              },
                            ],
                          },
                          {
                            type: "box",
                            layout: "baseline",
                            spacing: "sm",
                            contents: [
                              {
                                type: "text",
                                color: "#aaaaaa",
                                size: "sm",
                                flex: 2,
                                text: "建立時間",
                              },
                              {
                                type: "text",
                                text: dratime,
                                wrap: true,
                                color: "#666666",
                                size: "sm",
                                flex: 5,
                              },
                            ],
                          },
                          {
                            type: "box",
                            layout: "baseline",
                            spacing: "sm",
                            contents: [
                              {
                                type: "text",
                                text: "ID",
                                color: "#aaaaaa",
                                size: "sm",
                                flex: 2,
                              },
                              {
                                type: "text",
                                text: loid,
                                wrap: true,
                                color: "#666666",
                                size: "sm",
                                flex: 5,
                              },
                            ],
                          },
                          {
                            type: "box",
                            layout: "vertical",
                            contents: [
                              {
                                type: "text",
                                text: "項目",
                                size: "xl",
                                weight: "bold",
                              },
                              {
                                type: "box",
                                layout: "vertical",
                                contents: d_list_json,
                              },
                            ],
                          },
                        ],
                      },
                    ],
                  },
                },
              },
            ])

              .then(() => {
                //console.log("message sent");
              })

              .catch((err) => {
                //console.log("error", err);

                //liff.closeWindow();
              });
          });
          //ghend
          //ghy
          $(".next_2").click(function () {
            gtag("event", "Send_result", {
              event_category: "Send_result",
              event_label: profile.userId,
              transport_type: "beacon",
              event_callback: function () {
                var result_json = [{
                  type: "flex",
                  altText: name + "的抽籤已結束",
                  contents: {
                    type: "bubble",
                    body: {
                      type: "box",
                      layout: "vertical",
                      contents: [
                        {
                          type: "text",
                          text: "抽籤",
                          weight: "bold",
                          size: "xl",
                        },
                        {
                          type: "box",
                          layout: "vertical",
                          margin: "lg",
                          spacing: "sm",
                          contents: [
                            {
                              type: "box",
                              layout: "baseline",
                              spacing: "sm",
                              contents: [
                                {
                                  type: "text",
                                  text: "建立者",
                                  color: "#aaaaaa",
                                  size: "sm",
                                  flex: 2,
                                },
                                {
                                  type: "text",
                                  text: name,
                                  wrap: true,
                                  color: "#666666",
                                  size: "sm",
                                  flex: 5,
                                },
                              ],
                            },
                            {
                              type: "box",
                              layout: "baseline",
                              spacing: "sm",
                              contents: [
                                {
                                  type: "text",
                                  text: "狀態",
                                  color: "#aaaaaa",
                                  size: "sm",
                                  flex: 2,
                                },
                                {
                                  type: "text",
                                  text: "已結束",
                                  wrap: true,
                                  color: "#666666",
                                  size: "sm",
                                  flex: 5,
                                },
                              ],
                            },
                            {
                              type: "box",
                              layout: "baseline",
                              spacing: "sm",
                              contents: [
                                {
                                  type: "text",
                                  color: "#aaaaaa",
                                  size: "sm",
                                  flex: 2,
                                  text: "建立時間",
                                },
                                {
                                  type: "text",
                                  text: dratime,
                                  wrap: true,
                                  color: "#666666",
                                  size: "sm",
                                  flex: 5,
                                },
                              ],
                            },
                            {
                              type: "box",
                              layout: "baseline",
                              spacing: "sm",
                              contents: [
                                {
                                  type: "text",
                                  text: "ID",
                                  color: "#aaaaaa",
                                  size: "sm",
                                  flex: 2,
                                },
                                {
                                  type: "text",
                                  text: loid,
                                  wrap: true,
                                  color: "#666666",
                                  size: "sm",
                                  flex: 5,
                                },
                              ],
                            },
                            {
                              type: "box",
                              layout: "vertical",
                              contents: [
                                {
                                  type: "text",
                                  text: "項目",
                                  size: "xl",
                                  weight: "bold",
                                },
                                {
                                  type: "box",
                                  layout: "vertical",
                                  contents: d_list_json,
                                },
                              ],
                            },
                            {
                              type: "box",
                              layout: "vertical",
                              contents: [
                                {
                                  type: "text",
                                  text: "結果",
                                  size: "xl",
                                  weight: "bold",
                                },
                                {
                                  type: "box",
                                  layout: "vertical",
                                  contents: [
                                    {
                                      type: "text",
                                      text: result,
                                      color: "#666666",
                                      size: "sm",
                                    },
                                  ],
                                },
                              ],
                            },
                          ],
                        },
                      ],
                    },
                    footer: {
                      type: "box",
                      layout: "vertical",
                      contents: [
                        {
                          type: "button",
                          action: {
                            type: "uri",
                            label: "建立其他抽籤",
                            uri: "https://line.me/R/app/1656214165-JPk2V1O2",
                          },
                          color: "#6381d5",
                        },
                      ],
                    },
                  },
                },
                ]
                liff.sendMessages(result_json).then(() => {
                  liff.closeWindow();
                })

                  .catch((err) => {
                  });
              },
            });
          });
        })
        .catch((err) => {
        });
    })
    .catch((err) => {
    });
</script>